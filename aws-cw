#!/bin/bash

usage() {
  echo "Usage: $(basename $0) [cloudwatch log group name] [cloudwatch log group's stream name] [-o|--outfile file_name] [-p|--profile AWS Profile Name] [-r|--region AWS Region Name]"
  echo ""
  echo "Options:"
  echo "  -o, --outfile FILE   Save logs to file instead of displaying"
  echo "  -p, --profile NAME   AWS Profile Name"
  echo "  -r, --region NAME    AWS Region Name"
  echo "  -h, --help           Show this help message"
  echo ""
  echo "Examples:"
  echo "  $(basename $0)                                    # Interactive mode (requires fzf)"
  echo "  $(basename $0) /aws/lambda/my-function           # Interactive stream selection"
  echo "  $(basename $0) /aws/lambda/my-function stream-1   # View specific log stream"
  echo "  $(basename $0) /aws/lambda/my-function stream-1 --profile prod --region us-east-1"
  echo "  $(basename $0) /aws/lambda/my-function stream-1 --outfile logs.txt"
}

POSITIONAL_ARGS=()

while [[ $# -gt 0 ]]; do
  case $1 in
    -o|--outfile)
      OUTFILE="$2"
      shift
      shift
      ;;
    -r|--region)
      AWS_REGION="$2"
      shift
      shift
      ;;
    -p|--profile)
      AWS_PROFILE="$2"
      shift
      shift
      ;;
    -h|--help)
      usage
      shift
      exit 0
      ;;
    -*|--*)
      echo -e "${RED}${CROSS_MARK} Unknown option $1${NC}"
      usage
      exit 1
      ;;
    *)
      POSITIONAL_ARGS+=("$1")
      shift
      ;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}"

AWS_CW_LOGGROUP=$1
AWS_CW_LOGSTREAM=$2

# Parse the output of a CLI command and concatenate it into the cli_parsed variable.
#
# This function takes an optional argument, cli_jq_query, which is the jq query to use to parse the output of the CLI command.
#
# The function will execute the CLI command, parse the output using the provided jq query, and then concatenate it into the cli_parsed variable.  If the output contains a "nextToken" field, the function will return the nextToken value.  If the output does not contain a "nextToken" field, the function will return the empty string.
__generic_pagination_parse() {
  if [ ! -z "$cli_output" ]; then
    if grep -q "Exception" <<< "${cli_output}"; then
      log_fatal "AWS query returned an error: ${BOLD}${cli_output}${NC}"
    fi
    cli_parsed+="$(echo "$cli_output" | jq -r "${cli_jq_query}")"
    next_token=$(echo "$cli_output" | jq -r ".nextToken")
  else
    log_fatal "${BOLD}cli_output${NC} is empty"
  fi
}

# A generic function to get a list of items from AWS.
#
# This function takes two variables as input:
#  - cli_command: The CLI command to use to get the list of items.
#  - cli_jq_query: The jq query to use to parse the output of the CLI
#    command.
#
# The function will execute the CLI command, parse the output using the
# provided jq query, and then loop over the output and concatenate it
# into the cli_parsed variable.  If the output contains a "nextToken"
# field, the function will loop over the output until there are no more
# items to retrieve from AWS.  The function will sleep for 1 second
# between each iteration of the loop.
__generic_getter() {
  if [[ -z "$cli_command" || -z "$cli_jq_query" ]]; then
    log_fatal "${BOLD}cli_command${NC} or ${BOLD}cli_jq_query${NC} is not defined"
  fi
  cli_output=$($cli_command)
  __generic_pagination_parse
  while [ "$next_token" != "null" ]; do
    sleep 1
    cli_output=$($cli_command --next-token "$next_token")
    __generic_pagination_parse
  done
}

# Interactively choose a log group to query from.
#
# This function will query AWS for a list of log groups, and then use fzf to
# prompt the user to select one of the options.  If the user does not select
# an option, the function will exit with a non-zero status code.
choose_loggroup_interactive() {
  local choice
  local cli_command="aws logs describe-log-groups --region ${AWS_REGION} --profile ${AWS_PROFILE}"
  local cli_output
  local cli_parsed
  local cli_jq_query='.logGroups[] | "\(.logGroupName) , CreationTime: \(.creationTime / 1000 | strflocaltime("%Y-%m-%d %H:%m:%S %Z"))"'
  local next_token

  __generic_getter

  choice=$(echo "$cli_parsed" | __fzf_base_fzf --ansi --no-preview --border-label " ðŸ“‚ Log Groups " | sed 's/^\*//g' | awk '{print $1}' || true)
  if [[ -z "${choice}" ]]; then
    log_fatal "You did not choose any of loggroups"
  else
    AWS_CW_LOGGROUP="${choice}"
  fi
}

# Allows the user to interactively select a log stream from AWS CloudWatch.
# Retrieves and lists log streams for the specified log group in descending order based on the last event time.
# Uses fzf for interactive selection, and sets the chosen log stream name to AWS_CW_LOGSTREAM.
# Exits with an error message if no option is selected.
choose_logstream_interactive() {
  local choice
  local cli_command="aws logs describe-log-streams --log-group-name ${AWS_CW_LOGGROUP} --order-by LastEventTime --descending --region ${AWS_REGION} --profile ${AWS_PROFILE}"
  local cli_output
  local cli_parsed
  local cli_jq_query='.logStreams[] | "\(.logStreamName) , Last Event: \(.lastEventTimestamp / 1000 | strflocaltime("%Y-%m-%d %H:%m:%S %Z"))"'
  local next_token

  __generic_getter

  choice="$(echo "$cli_parsed" | __fzf_base_fzf --no-preview --border-label " ðŸ“ Log Streams " | sed 's/^\*//g' | awk '{print $1}' || true)"
  if [[ -z "${choice}" ]]; then
    log_fatal "You did not choose any of the logstreams"
  else
    AWS_CW_LOGSTREAM="${choice}"
  fi
}

[[ -z ${AWS_CW_LOGGROUP} ]] && {
  if ${IS_FZF}; then
    choose_loggroup_interactive || { log_fatal "Could not get log groups"; }
  else
    log_fatal "Log Group is not defined!"
  fi
}

[[ -z ${AWS_CW_LOGSTREAM} ]] && {
  if ${IS_FZF}; then
    choose_logstream_interactive || { log_fatal "Could not get log streams"; }
  else
    log_fatal "Log Group's Stream is not defined!"
  fi
}

check_aws_profile
check_aws_region

log_ok "${BOLD}AWS Profile:${NC} ${AWS_PROFILE}"
log_ok "${BOLD}AWS Region:${NC} ${AWS_REGION}"
log_ok "${BOLD}Log Group:${NC} ${AWS_CW_LOGGROUP}"
log_ok "${BOLD}Log Group Stream:${NC} ${AWS_CW_LOGSTREAM}"
log_ok "${BOLD}Command for direct query:${NC} $0 '${AWS_CW_LOGGROUP}' '${AWS_CW_LOGSTREAM}' --profile ${AWS_PROFILE} --region ${AWS_REGION}"

[[ ! -z ${OUTFILE} ]] && { log_ok "${BOLD}Redirecting output to:${NC} ${OUTFILE}"; }

# Retrieves log events from a specified AWS CloudWatch log group and log stream.
# If log events are found, they are either printed to the console or redirected to an output file.
# If fzf is available and enabled, allows interactive selection of request IDs from the log events.
# Exits with an error message if no log events are retrieved.
get_logs() {
    local log_events log_events_json
    log_events_json=$(aws logs get-log-events \
        --log-group-name ${AWS_CW_LOGGROUP} \
        --log-stream-name ${AWS_CW_LOGSTREAM} \
        --region ${AWS_REGION} \
        --profile ${AWS_PROFILE})
    if [[ -z "${log_events_json}" || $(echo "${log_events_json}" | jq '.events | length') -eq 0 ]]; then
      log_fatal "Could not get log events"
    fi
    log_events=$(echo "${log_events_json}" \
        | jq -r '.events[].message')
    [[ -n "${OUTFILE}" ]] && { echo -e "${log_events}"; return ; }
    if ${IS_FZF}; then
      request_ids=$(echo "${log_events}" | grep -i "START RequestId" | awk '{print $3}' | sed 's/"//g')
      echo -e "${request_ids}" | __fzf_base_fzf --ansi --height 90% \
        --border-label " ðŸ“” Log Events " \
        --header "SHIFT-UP/DOWN: scroll up/down" \
        --header-first \
        --tiebreak begin \
        --preview-window right,80%,wrap \
        --preview-border rounded \
        --preview-label " ðŸ“œ Log " \
        --preview-label-pos 0 \
        --preview "echo '${log_events}' | sed -n '/START RequestId: {}/,/REPORT RequestId: {}/p'"
    else
      echo -e "${log_events}"
    fi
}

REDIRECT=/dev/tty

[[ -n ${OUTFILE} ]] && REDIRECT=${OUTFILE}

get_logs > ${REDIRECT}

